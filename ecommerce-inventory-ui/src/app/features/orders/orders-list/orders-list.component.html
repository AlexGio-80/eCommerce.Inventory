<div class="orders-container">
  <div class="header-section">
    <h1>ðŸ“¦ Ordini</h1>
    <span class="spacer"></span>
    <button mat-raised-button color="primary" (click)="refreshOrders()">
      <mat-icon>refresh</mat-icon> Aggiorna
    </button>
  </div>

  <app-order-status-monitor></app-order-status-monitor>

  <div class="orders-header">
    <div class="actions">
      <!-- Quick Filter Search -->
      <mat-form-field appearance="outline" style="width: 250px;">
        <mat-label>Search</mat-label>
        <input matInput placeholder="Search all columns..." [(ngModel)]="quickFilterText"
          (input)="onQuickFilterChanged($event)">
        <button mat-icon-button matSuffix *ngIf="quickFilterText" (click)="clearQuickFilter()">
          <mat-icon>clear</mat-icon>
        </button>
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <!-- Filter Presets -->
      <mat-form-field appearance="outline" style="width: 200px;">
        <mat-label>Filter Preset</mat-label>
        <mat-select [(ngModel)]="filterPreset" (selectionChange)="onFilterPresetChange($event.value)">
          <mat-option *ngFor="let preset of filterPresets" [value]="preset.value">
            {{ preset.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Clear All Filters Button -->
      <button mat-raised-button (click)="clearAllFilters()">
        <mat-icon>filter_alt_off</mat-icon>
        Clear Filters
      </button>

      <!-- Export Menu -->
      <button mat-raised-button [matMenuTriggerFor]="exportMenu">
        <mat-icon>download</mat-icon>
        Export
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportToCsv()">
          <mat-icon>description</mat-icon>
          <span>Export as CSV</span>
        </button>
        <button mat-menu-item (click)="exportToExcel()">
          <mat-icon>table_chart</mat-icon>
          <span>Export as Excel</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="exportSelectedRows()" [disabled]="selectedRows.length === 0">
          <mat-icon>check_box</mat-icon>
          <span>Export Selected ({{ selectedRows.length }})</span>
        </button>
      </mat-menu>

      <button mat-raised-button color="primary" (click)="syncOrders()" [disabled]="isSyncing">
        <mat-icon>sync</mat-icon>
        {{ isSyncing ? 'Syncing...' : 'Sync Orders' }}
      </button>

      <!-- Grid Options Menu -->
      <button mat-icon-button [matMenuTriggerFor]="gridMenu" matTooltip="Grid Options">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #gridMenu="matMenu">
        <button mat-menu-item [matMenuTriggerFor]="columnsMenu">
          <mat-icon>view_column</mat-icon>
          <span>Columns</span>
        </button>
        <button mat-menu-item (click)="saveGridState()">
          <mat-icon>save</mat-icon>
          <span>Save Configuration</span>
        </button>
        <button mat-menu-item (click)="resetGridState()">
          <mat-icon>refresh</mat-icon>
          <span>Reset to Defaults</span>
        </button>
      </mat-menu>

      <!-- Columns Sub-Menu -->
      <mat-menu #columnsMenu="matMenu">
        <div class="columns-menu-container" (click)="$event.stopPropagation()">
          <div *ngFor="let col of getAllColumns()" class="column-toggle-item">
            <mat-checkbox [checked]="isColumnVisible(col.field!)" (change)="toggleColumnVisibility(col.field!)">
              {{ col.headerName }}
            </mat-checkbox>
          </div>
        </div>
      </mat-menu>
    </div>
  </div>

  <div class="filters-container">
    <mat-form-field appearance="outline">
      <mat-label>From Date</mat-label>
      <input matInput type="date" [(ngModel)]="fromDate" (change)="onDateFilterChange()">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>To Date</mat-label>
      <input matInput type="date" [(ngModel)]="toDate" (change)="onDateFilterChange()">
    </mat-form-field>

    <mat-checkbox [(ngModel)]="excludeNullDates" (change)="onDateFilterChange()" class="filter-checkbox">
      Hide Unpaid/Null Date
    </mat-checkbox>
  </div>

  <!-- Bulk Actions Toolbar (shown when rows are selected) -->
  <div *ngIf="selectedRows.length > 0" class="bulk-actions-toolbar">
    <span class="selection-count">{{ selectedRows.length }} row(s) selected</span>
    <div class="bulk-actions">
      <button mat-raised-button color="primary" (click)="bulkMarkComplete()">
        <mat-icon>check_circle</mat-icon>
        Mark Complete
      </button>
      <button mat-raised-button color="warn" (click)="bulkMarkIncomplete()">
        <mat-icon>cancel</mat-icon>
        Mark Incomplete
      </button>
      <button mat-raised-button color="accent" (click)="exportSelectedRows()">
        <mat-icon>download</mat-icon>
        Export Selected
      </button>
      <button mat-button (click)="deselectAll()">
        <mat-icon>clear</mat-icon>
        Deselect All
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!isLoading" class="ag-grid-container">
    <ag-grid-angular style="width: 100%; height: 600px;" class="ag-theme-material" [rowData]="filteredOrders"
      [columnDefs]="columnDefs" [defaultColDef]="defaultColDef" [gridOptions]="gridOptions"
      (gridReady)="onGridReady($event)" (columnMoved)="onColumnMoved()" (columnVisible)="onColumnVisible()"
      (sortChanged)="onSortChanged()" (selectionChanged)="onSelectionChanged()">
    </ag-grid-angular>
  </div>
</div>